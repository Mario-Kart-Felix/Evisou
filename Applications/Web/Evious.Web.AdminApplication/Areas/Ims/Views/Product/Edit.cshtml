@using Evious.Web
@using Evious.Framework.Contract
@using Evious.Framework.Web.Controls
@using Evious.Ims.Contract
@model Evious.Ims.Contract.Model.Product
<style>
     .modal {
left: 50%;
bottom: auto;
right: auto;
padding: 0;
width: 940px;
margin-left: -470px;
background-color: #fff;
border: 1px solid rgba(0,0,0,.2);
box-shadow: 0 3px 9px rgba(0,0,0,.5);
background-clip: padding-box;
}
</style>
<div class="modal-header">    
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    @{
        if(Model.ID == 0)
        {
        <h4 class="modal-title" id="ModalLabel">添加新项目</h4>
        }
        else
        {
        <h4 class="modal-title" id="ModalLabel">编辑产品:</h4>
        }
    }    
</div>
@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "mainForm" }))
{
   
    <div class="modal-body">       
        <div class="alert alert-danger display-hide">
            <button class="close" data-close="alert"></button>
            表单有错误,请检查
        </div>
        <div class="alert alert-success display-hide">
            <button class="close" data-close="alert"></button>
            验证成功
        </div>
        <div class="form-horizontal">            
            <div class="tabbable">
                <ul class="nav nav-tabs">
                    <li class="active">
                        <a href="#tab_general" data-toggle="tab">
                            常规
                        </a>
                    </li>
                    <li>
                        <a href="#tab_meta" data-toggle="tab">
                            元语言
                        </a>
                    </li>
                    <li>
                        <a href="#tab_images" data-toggle="tab">
                            图片
                        </a>
                    </li>
                    <li>
                        <a href="#tab_reviews" data-toggle="tab">
                            评论 <span class="badge badge-success">
                                3
                            </span>
                        </a>
                    </li>
                    <li>
                        <a href="#tab_history" data-toggle="tab">
                            历史
                        </a>
                    </li>
                </ul>
                <div class="tab-content no-space">
                    <div class="tab-pane active" id="tab_general">
                        <div class="form-body">
                            <div class="form-group">
                                <label class="control-label col-md-2">图片：</label>
                                <div class="col-md-10">
                                    <div class="fileinput fileinput-new" >
                                        
                                        <div class="fileinput-new files" style="width: 200px; height: 170px;" id="thumbnail">
                                            @if (Model.ID == 0)
                                            {
                                                <img src="http://www.placehold.it/200x150/EFEFEF/AAAAAA&amp;text=no+image" style="border:solid 1px" alt="" />
                                            }
                                            else
                                            {
                                                <img src="@Url.StaticFile()@Model.CoverPicture" alt="@Model.Sku||@Model.Name" title="@Model.Sku||@Model.Name" style="border: solid 1px;width:200px;height:150px" />
                                            }
                                        </div> 
                                       <br/>
                                        <div id="progress" class="progress" style="width:180px">
                                            <div class="progress-bar progress-bar-success"></div>
                                        </div>
                                    </div>

                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">
                                    产品名称: <span class="required">
                                        *
                                    </span>
                                </label>
                                <div class="col-md-10">
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                            <i class="fa fa-cubes"></i>
                                        </span>
                                        <div class="input-icon right">
                                            <i class="fa"></i>
                                            @Html.TextBoxFor(m => m.Name, new { @class = "form-control text-box single-line" })
                                        </div>
                                    </div>
                                    <span class="help-inline">@Html.ValidationMessageFor(m => m.Name)</span>                                   
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">
                                    SKU: <span class="required">
                                        *
                                    </span>
                                </label>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                            <i class="fa fa-cubes"></i>
                                        </span>
                                        <div class="input-icon right">
                                            <i class="fa"></i>
                                            @Html.TextBoxFor(m => m.Sku, new { @class = "form-control text-box single-line" })
                                        </div>
                                    </div>
                                    <span class="help-inline">@Html.ValidationMessageFor(m => m.Sku)</span>
                                </div>
                                <label class="col-md-2 control-label">
                                    状态:
                                </label>
                                <div class="col-md-4">
                                    @Html.CheckBoxFor(m => m.Status, new { @id = "active", @class = "make-switch", @data_on_text = "公开", @data_off_text = "不公开" })

                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label col-md-2">封面：<span class="required">*</span></label>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                            <i class="fa fa-cubes"></i>
                                        </span>
                                        <div class="input-icon right ">
                                            <i class="fa"></i>
                                            @Html.TextBoxFor(m => m.CoverPicture, new { @class = "form-control text-box single-line", @id = "coverimage" })
                                        </div>
                                    </div>
                                    <span class="help-inline">@Html.ValidationMessageFor(m => m.CoverPicture)</span>

                                </div>
                                <div class="col-md-3">
                                    <a class="btn btn-success fileinput-button btn-small" title="上传">
                                        <i class="glyphicon glyphicon-plus"></i>
                                        <input id="productcoverupload" type="file" name="files[]">
                                    </a>
                                    <a id="deleteuploaded" class="btn btn-danger delete btn-small" title="删除">
                                        <i class="glyphicon glyphicon-trash"></i>
                                    </a>
                                    <span id="uploadmsg"></span>
                                </div>
                                
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">
                                    详细描述: 
                                </label>
                                <div class="col-md-10">
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                            <i class="fa fa-cubes"></i>
                                        </span>
                                        <div class="input-icon right">
                                            <i class="fa"></i>                                            
                                            @Html.TextAreaFor(m => m.Description, new { @class = "form-control", })                                            
                                        </div>
                                    </div>
                                    <span class="help-inline">@Html.ValidationMessageFor(m => m.Description)</span>   
                                    
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">
                                    短描述: 
                                </label>
                                <div class="col-md-10">
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                            <i class="fa fa-cubes"></i>
                                        </span>
                                        <div class="input-icon right">
                                            <i class="fa"></i>
                                            @Html.TextAreaFor(m => m.ShortDescription, new { @class = "form-control", })                                            
                                        </div>
                                    </div>
                                    <span class="help-inline">@Html.ValidationMessageFor(m => m.ShortDescription)</span>   
                                    
                                    <span class="help-block">
                                        在产品列表显示
                                    </span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="col-md-2 control-label">
                                    可用日期: <span class="required">
                                        *
                                    </span>
                                </label>
                                <div class="col-md-4">
                                    <div class="input-group input-medium date-picker input-daterange" data-date="10/11/2012" data-date-format="mm/dd/yyyy">
                                        @Html.TextBoxFor(m => m.AvailableFrom, new { @class = "form-control",@placeholder="开始" })
                                        <span class="input-group-addon">
                                            到
                                        </span>
                                        @Html.TextBoxFor(m => m.AvailableTo, new { @class = "form-control", @placeholder = "结束" })                                        
                                    </div>
                                    
                                    <span class="help-block">
                                        可用日期范围.
                                    </span>
                                </div>
                                <label class="col-md-2 control-label">
                                    本机销售价格:
                                </label>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">
                                            <i class="fa fa-cny"></i>
                                        </span>
                                        <div class="input-icon right">
                                            <i class="fa"></i>
                                            @Html.TextBoxFor(m => m.SellingPrice, new { @class = "form-control text-box single-line input-xsmall" })
                                        </div>
                                    </div>

                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="col-md-2 control-label">
                                    毛尺寸（cm）: <span class="required">
                                        *
                                    </span>
                                </label>
                                <div class="col-md-10">
                                    <div class="input-group input-large input-daterange">
                                        <span class="input-group-addon">
                                            长
                                        </span>
                                        @Html.TextBoxFor(m => m.PackingSize.Length, new { @class="form-control",@name="packinglength" })                                       
                                        <span class="input-group-addon">
                                            宽
                                        </span>
                                        @Html.TextBoxFor(m => m.PackingSize.Width, new { @class = "form-control", @name = "packingwidth" })                                     
                                        <span class="input-group-addon">
                                            高
                                        </span>
                                        @Html.TextBoxFor(m => m.PackingSize.Height, new { @class = "form-control", @name = "packingheight" })                                        
                                    </div>
                                    <span class="help-block">
                                        可用范围.
                                    </span>
                                </div>
                               
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">
                                    净尺寸（cm）: 
                                </label>
                                <div class="col-md-10">
                                    <div class="input-group input-large input-daterange">
                                        <span class="input-group-addon">
                                            长
                                        </span>
                                        @Html.TextBoxFor(m => m.NetSize.Length, new { @class = "form-control", @name = "netlength" })
                                        
                                        <span class="input-group-addon">
                                            宽
                                        </span>
                                        @Html.TextBoxFor(m => m.NetSize.Width, new { @class = "form-control", @name = "netwidth" })
                                        <span class="input-group-addon">
                                            高
                                        </span>
                                        @Html.TextBoxFor(m => m.NetSize.Height, new { @class = "form-control", @name = "netheight" })
                                      
                                    </div>
                                    <span class="help-block">
                                        可用范围.
                                    </span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">
                                    重量（g）: <span class="required">
                                        *
                                    </span>
                                </label>
                                <div class="col-md-10">
                                    <div class="input-group input-large input-daterange">
                                        <span class="input-group-addon">
                                            毛重量
                                        </span>
                                        @Html.TextBoxFor(m => m.PackWeight, new { @class = "spinner-input form-control", @name = "packingweight", maxlength = "3" })
                                        <span class="input-group-addon">
                                            净重量
                                        </span>
                                        @Html.TextBoxFor(m => m.Weight, new { @class = "spinner-input form-control", @name = "netweight", maxlength = "3" })

                                    </div>
                                    <span class="help-block">
                                        可用范围.
                                    </span>
                                </div>
                            </div>                                                        
                           
                        </div>
                    </div>
                    <div class="tab-pane" id="tab_meta">
                        <div class="form-body">
                            <div class="form-group">
                                <label class="col-md-2 control-label">Meta Title:</label>
                                <div class="col-md-10">
                                    @Html.TextBoxFor(m => m.MetaTitle, new { @class = "form-control maxlength-handler" ,@maxlength="100", @placeholder="" })                                   
                                    <span class="help-block">
                                        最多 100 个字
                                    </span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">Meta Keywords:</label>
                                <div class="col-md-10">
                                    @Html.TextAreaFor(m => m.MetaKeywords, new { @class = "form-control maxlength-handler", @maxlength = "1000", @rows = "8" })
                                    <span class="help-block">
                                        最多 1000 个字
                                    </span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-2 control-label">Meta Description:</label>
                                <div class="col-md-10">
                                    @Html.TextAreaFor(m => m.MetaDescription, new { @class = "form-control maxlength-handler", @maxlength = "255", @rows = "4" })                                   
                                    <span class="help-block">
                                        最多 255 个字
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="tab_images">
                        <div class="form-body">
                            <div class="form-group">                               
                                <div id="fileupload">
                                    <div id="tab_images_uploader_container" class="text-align-reverse margin-bottom-10 col-md-12">
                                        <div class="row fileupload-buttonbar">
                                            <div class="col-lg-12">
                                                <!-- The fileinput-button span is used to style the file input field as button -->
                                                <span class="btn green fileinput-button">
                                                    <i class="fa fa-plus"></i>
                                                    <span>
                                                        添加...
                                                    </span>
                                                    <input type="file" name="files[]" multiple="">
                                                </span>
                                                <button type="submit" class="btn blue start">
                                                    <i class="fa fa-upload"></i>
                                                    <span>
                                                        上传
                                                    </span>
                                                </button>
                                                <button type="reset" class="btn warning cancel">
                                                    <i class="fa fa-ban-circle"></i>
                                                    <span>
                                                        取消
                                                    </span>
                                                </button>
                                                <button type="button" class="btn red delete">
                                                    <i class="fa fa-trash"></i>
                                                    <span>
                                                        删除
                                                    </span>
                                                </button>
                                                <input type="checkbox" class="toggle">
                                                <!-- The global file processing state -->
                                                <span class="fileupload-process">
                                                </span>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="row col-lg-12">
                                        <div class="table-container">
                                            <div class="row fileupload-buttonbar">
                                                <!-- The global progress information -->
                                                <div class="col-lg-12 fileupload-progress fade">
                                                    <!-- The global progress bar -->
                                                    <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                                        <div class="progress-bar progress-bar-success" style="width:0%;">
                                                        </div>
                                                    </div>
                                                    <!-- The extended global progress information -->
                                                    <div class="progress-extended">
                                                        &nbsp;
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- The table listing the files available for upload/download -->

                                            <table role="presentation" class="table table-bordered table-hover">
                                                <thead id="head">
                                                    <tr role="row" class="heading">
                                                        <th width="8%">
                                                            图片
                                                        </th>
                                                        <th width="25%">
                                                            Label&URL
                                                        </th>
                                                        <th width="8%">
                                                            排序
                                                        </th>

                                                        <th width="10%">
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody class="files"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>                        
                     </div>
                    <div class="tab-pane" id="tab_reviews">
                        <div class="table-container">
                            <table class="table table-striped table-bordered table-hover" id="datatable_reviews">
                                <thead>
                                    <tr role="row" class="heading">
                                        <th width="5%">
                                            评论&nbsp;#
                                        </th>
                                        <th width="10%">
                                            评论日期
                                        </th>
                                        <th width="10%">
                                            买家
                                        </th>
                                        <th width="20%">
                                            评论内容
                                        </th>
                                        <th width="10%">
                                            状态
                                        </th>
                                        <th width="10%">
                                            动作
                                        </th>
                                    </tr>
                                    <tr role="row" class="filter">
                                        <td>
                                            <input type="text" class="form-control form-filter input-sm" name="product_review_no">
                                        </td>
                                        <td>
                                            <div class="input-group date date-picker margin-bottom-5" data-date-format="dd/mm/yyyy">
                                                <input type="text" class="form-control form-filter input-sm" readonly name="product_review_date_from" placeholder="From">
                                                <span class="input-group-btn">
                                                    <button class="btn btn-sm default" type="button"><i class="fa fa-calendar"></i></button>
                                                </span>
                                            </div>
                                            <div class="input-group date date-picker" data-date-format="dd/mm/yyyy">
                                                <input type="text" class="form-control form-filter input-sm" readonly name="product_review_date_to" placeholder="To">
                                                <span class="input-group-btn">
                                                    <button class="btn btn-sm default" type="button"><i class="fa fa-calendar"></i></button>
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-filter input-sm" name="product_review_customer">
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-filter input-sm" name="product_review_content">
                                        </td>
                                        <td>
                                            <select name="product_review_status" class="form-control form-filter input-sm">
                                                <option value="">Select...</option>
                                                <option value="pending">Pending</option>
                                                <option value="approved">Approved</option>
                                                <option value="rejected">Rejected</option>
                                            </select>
                                        </td>
                                        <td>
                                            <div class="margin-bottom-5">
                                                <button class="btn btn-sm yellow filter-submit margin-bottom"><i class="fa fa-search"></i> Search</button>
                                            </div>
                                            <button class="btn btn-sm red filter-cancel"><i class="fa fa-times"></i> Reset</button>
                                        </td>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane" id="tab_history">
                        <div class="table-container">
                            <table class="table table-striped table-bordered table-hover" id="datatable_history">
                                <thead>
                                    <tr role="row" class="heading">
                                        <th width="25%">
                                            日期
                                        </th>
                                        <th width="55%">
                                            描述
                                        </th>
                                        <th width="10%">
                                            Notification
                                        </th>
                                        <th width="10%">
                                            动作
                                        </th>
                                    </tr>
                                    <tr role="row" class="filter">
                                        <td>
                                            <div class="input-group date datetime-picker margin-bottom-5" data-date-format="dd/mm/yyyy hh:ii">
                                                <input type="text" class="form-control form-filter input-sm" readonly name="product_history_date_from" placeholder="从">
                                                <span class="input-group-btn">
                                                    <button class="btn btn-sm default date-set" type="button"><i class="fa fa-calendar"></i></button>
                                                </span>
                                            </div>
                                            <div class="input-group date datetime-picker" data-date-format="dd/mm/yyyy hh:ii">
                                                <input type="text" class="form-control form-filter input-sm" readonly name="product_history_date_to" placeholder="到">
                                                <span class="input-group-btn">
                                                    <button class="btn btn-sm default date-set" type="button"><i class="fa fa-calendar"></i></button>
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-filter input-sm" name="product_history_desc" placeholder="内容" />
                                        </td>
                                        <td>
                                            <select name="product_history_notification" class="form-control form-filter input-sm">
                                                <option value="">Select...</option>
                                                <option value="pending">Pending</option>
                                                <option value="notified">Notified</option>
                                                <option value="failed">Failed</option>
                                            </select>
                                        </td>
                                        <td>
                                            <div class="margin-bottom-5">
                                                <button class="btn btn-sm yellow filter-submit margin-bottom"><i class="fa fa-search"></i> 搜索</button>
                                            </div>
                                            <button class="btn btn-sm red filter-cancel"><i class="fa fa-times"></i> 重置</button>
                                        </td>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button type="submit" id="submitbutton" class="btn blue btn-sm default"><i class="fa fa-check"></i> 提交</button>
        <button type="button" class="btn btn-sm default" id="cancel" data-dismiss="modal">撤销</button>
    </div>

}
                                              
<style>
    .modal {
        z-index: 100 !important;
        outline: none;
        overflow-y: auto !important;
        /*//Fix content shifting to the right on modal open due to scrollbar closed*/
    }
</style>


<!-- BEGIN JAVASCRIPTS(Load javascripts at bottom, this will reduce page load time) -->
<script id="template-upload" type="text/x-tmpl">
    {% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-upload fade">
        <td>
            <span class="preview"></span>
        </td>
        <td>
            <p class="name">{%=file.name%}</p>
            <strong class="error text-danger label label-danger"></strong>
        </td>
        <td>
            <p class="size">Processing...</p>
            <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                <div class="progress-bar progress-bar-success" style="width:0%;"></div>
            </div>
        </td>
        <td>
            {% if (!i && !o.options.autoUpload) { %}
            <button class="btn blue start" disabled>
                <i class="fa fa-upload"></i>
                <span>开始</span>
            </button>
            {% } %}
            {% if (!i) { %}
            <button class="btn red cancel">
                <i class="fa fa-ban"></i>
                <span>取消</span>
            </button>
            {% } %}
        </td>
    </tr>
    {% } %}
</script>
<!-- The template to display files available for download -->
<script id="template-download" type="text/x-tmpl">
    
    {% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-download fade">
        <td>
            <input type="hidden" value="{%=file.pictureid%}" name="pictureid" />
            <span class="preview">
                {% if (file.thumbnailUrl) { %}
                <a href="{%=file.url%}" target="_blank" title="{%=file.name%}" download="{%=file.name%}" data-gallery><img src="{%=file.thumbnailUrl%}"></a>
                {% } %}
            </span>
        </td>
        <td>
            <p class="name">               
                <input type="text" class="form-control" name="Label" placeholder="Label" value="{%=file.label%}">
                <input type="text" class="form-control" name="PictureURL" value="{%=file.url%}" readonly>   
                             
                {% if (file.url) { %}
                <a href="{%=file.url%}" title="{%=file.name%}" class="fancybox-button" data-rel="fancybox-button" download="{%=file.name%}" {%=file.thumbnailUrl?'data-gallery':''%}>{%=file.name%}</a>
                {% } else { %}
                <span>{%=file.name%}</span>
                {% } %}
                
            </p>
            {% if (file.error) { %}
            <div><span class="label label-danger">出错</span> {%=file.error%}</div>
            {% } %}
        </td>
        <td>
            <span class="size">@*{%=o.formatFileSize(file.size)%}*@
                <input type="number" class="form-control" name="SortOrder" value="{%=file.sortorder%}">
            </span>
        </td>
        <td>
            {% if (file.deleteUrl) { %}
            <button class="btn red delete btn-sm btndelete" data-type="{%=file.deleteType%}" data-url="{%=file.deleteUrl%}" {% if (file.deletewithcredentials) { %} data-xhr-fields='{"withCredentials":true}' {% } %}>
                <i class="fa fa-trash-o"></i>
                <span>删除</span>
            </button>
            <input type="checkbox" name="delete" value="1" class="toggle">
            {% } else { %}
            <button class="btn yellow cancel btn-sm">
                <i class="fa fa-ban"></i>
                <span>取消</span>
            </button>
            {% } %}
        </td>
    </tr>
    {% } %}
</script>
<script>
    var FormComponents = function () {
        var handleCheckForm = function () {
            var form = $("#mainForm");
            var error = $('.alert-danger', form);
            var success = $('.alert-success', form);

            form.validate({
                errorElement: 'span', //default input error message container
                errorClass: 'help-block help-block-error', // default input error message class
                focusInvalid: false, // do not focus the last invalid input
                ignore: "",  // validate all fields including form hidden input
                rules: {
                    Name: {
                        minlength: 2,
                        required: true,
                    },
                    AvailableFrom: {
                        required: true,
                    },
                    AvailableTo: {
                        required: true,
                    },
                    Sku: {
                        minlength: 8,
                        maxlength:9,
                        required: true,
                        cache: false,
                        remote:"AjaxCheckForm"+ encodeURIComponent($("#Sku").val()),
                    },
                    PackingSize_Length: {
                        required: true,
                    },
                    packingwidth: {
                        required: true,
                    },
                    packingheight: {
                        required: true,
                    }


                },
                //messages: { // custom messages for radio buttons and checkboxes
                //    Sku: {
                //        required: "Please select a Membership type"
                //    },
                //},
                invalidHandler: function (event, validator) { //display error alert on form submit
                    success.hide();
                    error.show();
                    Metronic.scrollTo(error, -200);

                },

                errorPlacement: function (error, element) { // render error placement for each input type
                    var icon = $(element).parent('.input-icon').children('i');
                    icon.removeClass('fa-check').addClass("fa-warning");
                    icon.attr("data-original-title", error.text()).tooltip({ 'container': 'body' });
                },

                highlight: function (element) { // hightlight error inputs
                    $(element)
                        .closest('.form-group').removeClass("has-success").addClass('has-error'); // set error class to the control group
                },

                unhighlight: function (element) { // revert the change done by hightlight

                },

                success: function (label, element) {
                    var icon = $(element).parent('.input-icon').children('i');
                    $(element).closest('.form-group').removeClass('has-error').addClass('has-success'); // set success class to the control group
                    icon.removeClass("fa-warning").addClass("fa-check");
                },

                submitHandler: function (form) {
                    success.show();
                    error.hide();
                    //form[0].submit(alert('dasdas')); // submit the form
                }
            });


            $("#submitbutton").click(function (e) {
                if (!form.valid()) {
                    e.preventDefault();
                }

            });
        };

        return {
            init: function () { 
                handleCheckForm();
            }
        }


    }();

    var FormFileUpload = function () {
        // Handles Image Preview using jQuery Fancybox plugin
        var handleFancybox = function () {
            if (!$(document).delegate.fancybox) {
                return;
            }

            if ($(document).delegate(".fancybox-button").size() > 0) {
                $(document).delegate(".fancybox-button").fancybox({
                    groupAttr: 'data-rel',
                    prevEffect: 'none',
                    nextEffect: 'none',
                    closeBtn: true,
                    helpers: {
                        title: {
                            type: 'inside'
                        }
                    }
                });
            }
        };


        return {

            //main function to initiate the module
            init: function () {
                handleFancybox();

                $('#fileupload').find('thead').hide();
                // Initialize the jQuery File Upload widget:
                $('#fileupload').fileupload({
                    disableImageResize: false,
                    url: "@Url.StaticFile()/UploadHandler.ashx",//
                    autoUpload: false,
                    disableImageResize: /Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),
                    maxFileSize: 5000000,
                    acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
                    formData: { subfolder: 'ims' }
                    // Uncomment the following to send cross-domain cookies:
                    //xhrFields: {withCredentials: true},                
                }).bind('fileuploadsubmit', function (e, data) {                    
                    $('#fileupload').find('thead').show();
                });
                
                // Enable iframe cross-domain access via redirect option:
                $('#fileupload').fileupload(
                    'option',
                    'redirect',
                    window.location.href.replace(
                        /\/[^\/]*$/,
                        '/cors/result.html?%s'
                    )
                );

                // Upload server status check for browsers with CORS support:
                @*if ($.support.cors) {
                    $.ajax({
                        url: $('#fileupload').attr("action"),
                        type: 'HEAD'
                    }).fail(function () {
                        $('<div class="alert alert-danger"/>')
                            .text('Upload server currently unavailable - ' +
                                    new Date())
                            .appendTo('#fileupload');
                    });
                }*@

                // Load & display existing files:
                $('#fileupload').addClass('fileupload-processing');
               $.ajax({
                    // Uncomment the following to send cross-domain cookies:
                    //xhrFields: {withCredentials: true},
                    url: '@Url.StaticFile()/UploadHandler.ashx?productid=@Model.ID',//"@Url.StaticFile()/UploadHandler.ashx",//
                    dataType: 'json',
                    context: $('#fileupload')[0]
                }).always(function () {
                    $(this).removeClass('fileupload-processing');
                   // $('#fileupload').find('thead').show();
                }).done(function (result) {
                    var i = result.files;
                    if (typeof (result.files.length) != 'undefined')
                    {
                        $('#fileupload').find('thead').show();
                    }
                    $(this).fileupload('option', 'done')
                    .call(this, $.Event('done'), { result: result });
                });

                //更改部分
                var fileUploadButtonBar = $('#fileupload').find('.fileupload-buttonbar');
                fileUploadButtonBar.find('.delete').click(function () {
                    $('#fileupload').find('thead').hide();
                });

                $('.files').delegate(".btndelete", "click", function () {
                   
                    if ($('.files').find('.btndelete').length == 1) {
                        $('#fileupload').find('thead').hide()
                    }
                });


            }

        };

    }();

    var ProductsEditComponents = function () {    

        var handleProductCoverUpload = function () {

            var url = "@Url.StaticFile()/UploadHandler.ashx",
            uploadButton = $('<button/>')
                .addClass('btn btn-primary')
                .prop('disabled', true)
                .prop('type', 'button')
                .text('处理中...')
                .on('click', function () {
                    var $this = $(this),
                        data = $this.data();
                    $this
                        .off('click')
                        .text('终止')
                        .on('click', function () {
                            $this.remove();
                            data.abort();
                        });
                    data.submit().always(function (data) {
                        $this.remove();
                    });
                });

            var coverimge = $('#coverimage');

            var filename;

            $('#deleteuploaded').hide();
            $('#progress').hide();



            $('#productcoverupload').fileupload({

                url: url,//"@Url.StaticFile()/UploadHandler.ashx",
                dataType: 'json',
                autoUpload: false,
                maxNumberOfFiles: 1,
                limitConcurrentUploads: 1,
                acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
                maxFileSize: 5000000, // 5 MB           
                disableImageResize: /Android(?!.*Chrome)|Opera/
                    .test(window.navigator.userAgent),
                previewMaxWidth: 180,
                previewMaxHeight: 140,
                previewCrop: true,
                //uploadTemplateId: null,
                //downloadTemplateId: null,
                filesContainer: $('div.files'),
                uploadTemplateId: null,
                downloadTemplateId: null,
                uploadTemplate: function (o) {
                    var rows = $();
                    $.each(o.files, function (index, file) {
                        $('div.files').empty();
                        var row = $('<div class="template-upload fade">' +
                            '<span class="preview"></span><div class="name"></div>' +                            
                            '</div>');
                        row.find('.name').text(file.name);
                       
                        rows = row;
                    });
                    return rows;
                },
                
            }).on('fileuploadadd', function (e, data) {
                if ($("#thumbnail:has(div)").length == 0) {
                    $('#uploadmsg').empty();
                    //$('#progress').hide(function () {
                    //    $('#progress .progress-bar').css('width', '0%');
                    //});

                    $('#thumbnail').empty();
                    data.context = $('<div/>').appendTo('#thumbnail');
                    //$('#uploadtext').text('更改');
                    $.each(data.files, function (index, file) {
                        var node = $('<p/>').append($('<span/>').text(file.name));
                        if (!index) {
                            $('#uploadmsg').append(uploadButton.clone(true).data(data));
                            filename = file.name;
                        }
                        node.appendTo(data.context);
                    });
                } else {
                    $('#uploadmsg').empty();
                    //$('#progress').hide(function () {
                    //    $('#progress .progress-bar').css('width', '0%');
                    //});

                    $('#thumbnail').empty();
                    data.context = $('<div/>').appendTo('#thumbnail');
                    $.each(data.files, function (index, file) {
                        var node = $('<p/>').append($('<span id="filename"/>').text(file.name));
                        if (!index) {
                            $('#uploadmsg').append(uploadButton.clone(true).data(data));
                            filename = file.name;
                        }
                        node.appendTo(data.context);
                    });
                }

            }).on('fileuploadprocessalways', function (e, data) {
                var index = data.index,
                    file = data.files[index],
                    node = $(data.context.children()[index]);
                if (file.preview) {                   
                    node
                        .prepend('<br>')
                        .prepend(file.preview);
                }
                if (file.error) {
                    $('#uploadmsg')
                        .append('<br>')
                        .append($('<span class="text-danger"/>').text(file.error));
                }
                if (index + 1 === data.files.length) {
                    $('#uploadmsg').find('button')
                       // .text('上传')
                        .html('<i class="fa fa-upload"></i>')
                        .prop('disabled', !!data.files.error);
                }
                $('#progress').show();
            }).on('fileuploadprogressall', function (e, data) {
                $('#progress').show();
                var progress = parseInt(data.loaded / data.total * 100, 10);
                $('#progress .progress-bar').css(
                    'width',
                    progress + '%'
                );
            }).on('fileuploaddone', function (e, data) {
                $('#productcoverupload').prop('disabled', true);
                $.each(data.result.files, function (index, file) {

                    if (file.url) {
                        var link = $('<a>')
                            .addClass('fancybox-button')
                            .prop('title', file.name)
                            //.attr('target', '_blank')
                            .prop('href', file.url)
                            .attr('data-ref', 'fancybox-button')
                            .text(file.name);
                        var deletebutton = $('#deleteuploaded');
                        $(data.context.children()[index])
                            .wrap(link);
                        $("div.name").empty();
                        link.appendTo($("div.name"));
                        deletebutton.show(function () {
                            deletebutton.attr("data-type", file.deleteType).attr("data-url", file.deleteUrl)
                        });

                        deletebutton.click(function () {

                            $.ajax({
                                xhrFields: { withCredentials: true },
                                url: file.deleteUrl,
                                type: 'DELETE',
                                success: function (response) {
                                    $('#productcoverupload').prop('disabled', false);
                                    $('#thumbnail').html('<img src="http://www.placehold.it/200x150/EFEFEF/AAAAAA&amp;text=no+image" alt="" />');
                                    $('#progress').hide(function () {
                                        $('#progress .progress-bar').css('width', '0%');
                                    });
                                    deletebutton.hide();
                                    coverimge.val('');
                                }
                            })
                        });
                        coverimge.val(file.url);
                        //.append(deleteButton.clone(true));

                    } else if (file.error) {
                        var error = $('<span class="text-danger"/>').text(file.error);
                        //$(data.context.children()[index])
                        $('#uploadmsg')
                            .append('<br>')
                            .append(error);
                    }
                });
            }).on('fileuploadfail', function (e, data) {
                $.each(data.files, function (index) {
                    var error = $('<span class="text-danger"/>').text('文件上传失败.');
                    //$(data.context.children()[index])
                    $('#uploadmsg')
                        .append('<br>')
                        .append(error);
                });
            }).prop('disabled', !$.support.fileInput)
            .parent().addClass($.support.fileInput ? undefined : 'disabled')//;
        .bind('fileuploadsubmit', function (e, data) {
            data.formData =
                [{
                    name: "subfolder",
                    value: "ims"
                }, {
                    name: 'Filename',
                    value: filename
                }];
        });
        }
      

        var handleReviews = function () {

            var grid = new Datatable();

            grid.init({
                src: $("#datatable_reviews"),
                onSuccess: function (grid) {
                    // execute some code after table records loaded
                },
                onError: function (grid) {
                    // execute some code on network or other general error  
                },
                loadingMessage: 'Loading...',
                dataTable: { // here you can define a typical datatable settings from http://datatables.net/usage/options 

                    // Uncomment below line("dom" parameter) to fix the dropdown overflow issue in the datatable cells. The default datatable layout
                    // setup uses scrollable div(table-scrollable) with overflow:auto to enable vertical scroll(see: assets/global/scripts/datatable.js). 
                    // So when dropdowns used the scrollable div should be removed. 
                    //"dom": "<'row'<'col-md-8 col-sm-12'pli><'col-md-4 col-sm-12'<'table-group-actions pull-right'>>r>t<'row'<'col-md-8 col-sm-12'pli><'col-md-4 col-sm-12'>>",

                    "lengthMenu": [
                        [10, 20, 50, 100, 150, -1],
                        [10, 20, 50, 100, 150, "All"] // change per page values here
                    ],
                    "pageLength": 10, // default record count per page
                    "ajax": {
                       // "url": "demo/ecommerce_product_reviews.php", // ajax source
                    },
                    "columnDefs": [{ // define columns sorting options(by default all columns are sortable extept the first checkbox column)
                        'orderable': true,
                        'targets': [0]
                    }],
                    "order": [
                        [0, "asc"]
                    ] // set first column as a default sort by asc
                }
            });
        }

        var handleHistory = function () {

            var grid = new Datatable();

            grid.init({
                src: $("#datatable_history"),
                onSuccess: function (grid) {
                    // execute some code after table records loaded
                },
                onError: function (grid) {
                    // execute some code on network or other general error  
                },
                loadingMessage: 'Loading...',
                dataTable: { // here you can define a typical datatable settings from http://datatables.net/usage/options 
                    "lengthMenu": [
                        [10, 20, 50, 100, 150, -1],
                        [10, 20, 50, 100, 150, "All"] // change per page values here
                    ],
                    "pageLength": 10, // default record count per page
                    "ajax": {
                       // "url": "demo/ecommerce_product_history.php", // ajax source
                    },
                    "columnDefs": [{ // define columns sorting options(by default all columns are sortable extept the first checkbox column)
                        'orderable': true,
                        'targets': [0]
                    }],
                    "order": [
                        [0, "asc"]
                    ] // set first column as a default sort by asc
                }
            });
        }

        var initComponents = function () {
            //init datepickers
            $('.date-picker').datepicker({
                rtl: Metronic.isRTL(),
                language: 'zh-CN',
                autoclose: true
            });

            //init datetimepickers
            $(".datetime-picker").datetimepicker({
                isRTL: Metronic.isRTL(),
                autoclose: true,
                language: 'zh-CN',
                todayBtn: true,
                pickerPosition: (Metronic.isRTL() ? "bottom-right" : "bottom-left"),
                minuteStep: 10
            });

            //init maxlength handler
            $('.maxlength-handler').maxlength({
                limitReachedClass: "label label-danger",
                alwaysShow: true,
                threshold: 5
            });
        }

        var handleSpinners = function () {
            $('.spinner').spinner();
            $('#spinner1').spinner();
            $('#spinner2').spinner({ disabled: true });
            $('#spinner3').spinner({ value: 0, min: 0, max: 10 });
            $('#spinner4').spinner({ value: 0, step: 5, min: 0, max: 200 });
        }

        return {
            //main function to initiate the module
            init: function () {
                handleProductCoverUpload();
                initComponents();
                //handleSpinners();              
                //handleReviews();
               // handleHistory();
            }
        };
    }();

    $(function () {       
        Metronic.init();        
        ProductsEditComponents.init();
        FormFileUpload.init();
        FormComponents.init();
        

    });
</script>




